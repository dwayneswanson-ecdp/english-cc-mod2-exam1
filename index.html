<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="google" content="notranslate" />
<title>Exam Builder – Instructor Portal</title>
<style>
  :root { --blue:#004080; --blue2:#0066cc; --bg:#f6f8fb; --card:#ffffff; --border:#d8dee9; }
  *{box-sizing:border-box}
  body{font-family:Inter, system-ui, Arial, sans-serif; background:var(--bg); margin:0; color:#1b1f23;}
  header{background:linear-gradient(135deg,var(--blue),var(--blue2)); color:#fff; padding:28px 18px; text-align:center;}
  header h1{margin:0; font-weight:800; letter-spacing:.3px}
  main{max-width:1000px; margin:28px auto; padding:0 16px 40px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:22px 20px; box-shadow:0 2px 10px rgba(0,0,0,.04); margin-bottom:18px;}
  h2{margin:8px 0 12px; color:var(--blue); font-size:20px}
  label{display:block; font-size:14px; margin-top:10px; color:#0f172a}
  input[type=text], input[type=number], textarea{width:100%; border:1px solid var(--border); border-radius:8px; padding:10px 12px; font-size:15px; background:#fff;}
  textarea{min-height:110px; resize:vertical}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:14px}
  .small{font-size:12px; color:#6b7280}
  .btn{background:var(--blue); color:#fff; border:none; padding:12px 18px; border-radius:10px; font-size:16px; cursor:pointer}
  .btn:hover{background:#003166}
  table{width:100%; border-collapse:collapse; margin-top:8px}
  th, td{border:1px solid var(--border); padding:8px; font-size:14px}
  th{background:#eef2ff; text-align:left}
  .gate{max-width:440px; margin:60px auto}
  .err{color:#b00020; font-size:13px; margin-left:10px; display:none}
</style>
</head>
<body>
<header>
  <h1>Exam Builder – Instructor Portal</h1>
</header>

<main>
  <!-- Password Gate -->
  <section class="card gate" id="gate">
    <h2>Instructor Access</h2>
    <label>Password
      <input type="password" id="gatePwd" placeholder="Enter password…" />
    </label>
    <div style="margin-top:12px">
      <button class="btn" id="gateBtn">Unlock</button>
      <span id="gateErr" class="err">Incorrect password.</span>
    </div>
  </section>

  <!-- Builder (hidden until unlock) -->
  <section id="builder" style="display:none">
    <div class="card">
      <h2>Step 1 — Exam Info</h2>
      <div class="row">
        <label>Exam Title
          <input type="text" id="examTitle" value="English Exam – Business Resources" />
        </label>
        <label>Class Code
          <input type="text" id="classCode" value="MDO2G3" />
        </label>
      </div>
      <div class="row">
        <label>Time Limit (minutes)
          <input type="number" id="timeLimit" min="5" max="180" step="5" value="40" />
        </label>
        <label>Email Subject Format
          <span class="small">Use placeholders: <b>(NAME)</b>, <b>(EXAM)</b>, <b>(CODE)</b></span>
          <input type="text" id="emailSubject" value="Results – (NAME) – (EXAM) ((CODE))" />
        </label>
      </div>
    </div>

    <div class="card">
      <h2>Step 2 — Email Delivery (EmailJS)</h2>
      <div class="row">
        <label>Public Key
          <input type="text" id="emailjsKey" placeholder="e.g., Bb0oPYBiZGQcyIz5r" />
        </label>
        <label>Service ID
          <input type="text" id="emailjsService" placeholder="e.g., service_opm4h6b" />
        </label>
      </div>
      <div class="row">
        <label>Template ID
          <input type="text" id="emailjsTemplate" placeholder="e.g., template_r0u784p" />
        </label>
        <label>Instructor Email (note)
          <input type="text" id="instructorEmail" placeholder="Configured in your EmailJS template" />
        </label>
      </div>
      <p class="small">Your EmailJS template must include variables <code>{{subject}}</code> and <code>{{message_html}}</code>.</p>
    </div>

    <div class="card">
      <h2>Step 3 — Vocabulary (up to 10 items)</h2>
      <p class="small">Leave unused rows blank. Each filled row becomes one matching question. Definitions from all filled rows are used as dropdown options for each word.</p>
      <table>
        <thead><tr><th>#</th><th>Word</th><th>Correct Definition</th></tr></thead>
        <tbody id="vocabBody"></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Step 4 — Part B Writing Prompt</h2>
      <label>Prompt Text
        <textarea id="promptText">You are a team leader. One of your suppliers has delayed an important delivery. Write a short email to your manager. In your email, explain the problem, suggest a solution, and use a polite and professional tone. You must use at least 3 words from the vocabulary list.</textarea>
      </label>
    </div>

    <div class="card">
      <h2>Step 5 — Generate Exam</h2>
      <button class="btn" id="generateBtn">Generate & Download index.html</button>
      <p class="small">This downloads a self-contained student exam (Login → Confirm → Exam, timer, fullscreen guard, anti-copy, EmailJS reporting).</p>
    </div>
  </section>
</main>

<script>
document.addEventListener("DOMContentLoaded", function() {

  /* ========== Gate (Instructor Access) ========== */
  const BUILDER_PASSWORD = "teacher2025";
  const gateSection = document.getElementById("gate");
  const builderSection = document.getElementById("builder");
  const gateBtn = document.getElementById("gateBtn");
  const gateErr = document.getElementById("gateErr");
  const gatePwd = document.getElementById("gatePwd");

  gateBtn.addEventListener("click", function() {
    const inputVal = gatePwd.value.trim();
    if (inputVal === BUILDER_PASSWORD) {
      gateErr.style.display = "none";
      gateSection.style.display = "none";
      builderSection.style.display = "block";
      console.log("✅ Access granted");
    } else {
      gateErr.style.display = "inline";
      console.warn("❌ Wrong password");
    }
  });
  gatePwd.addEventListener("keypress", function(e) { if (e.key === "Enter") gateBtn.click(); });

  /* ========== Blank Vocab Rows (no prefill) ========== */
  const tbody = document.getElementById("vocabBody");
  for (let i = 0; i < 10; i++) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td><input type="text" id="w${i}" value=""></td>
      <td><input type="text" id="d${i}" value=""></td>`;
    tbody.appendChild(tr);
  }

  /* ========== Build Exam HTML and Download ========== */
  function htmlEscape(s) {
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  function buildExamHTML(cfg) {
    // Prepare vocabulary arrays from filled rows only
    const words = [];
    const defs  = [];
    cfg.vocab.forEach(v => {
      const w = (v.word || "").trim();
      const d = (v.definition || "").trim();
      if (w && d) { words.push(w); defs.push(d); }
    });

    const qCount = words.length;
    if (qCount === 0) {
      alert("Please add at least one Word + Definition row.");
      return "";
    }

    // Build Part A <li> blocks; each select contains all definitions (shuffled at runtime)
    let partAItemsHTML = "";
    for (let i = 0; i < qCount; i++) {
      const word = htmlEscape(words[i]);
      const options = ['<option value="">-- Choose --</option>']
        .concat(defs.map(d => `<option>${htmlEscape(d)}</option>`))
        .join("");
      partAItemsHTML += `
        <li>${word}
          <select name="q${i+1}">
            ${options}
          </select>
        </li>`;
    }

    // Build correctAnswers object and wordNames array for the exam script
    const correctMap = {};
    for (let i = 0; i < qCount; i++) correctMap["q"+(i+1)] = defs[i];
    const correctAnswersJS = JSON.stringify(correctMap);
    const wordNamesJS      = JSON.stringify(words);

    const timeLimit = Math.max(5, +cfg.timeLimit || 40); // minutes

    // Email subject with placeholders
    const subjTemplate = (cfg.subject || "Results – (NAME) – (EXAM) ((CODE))");
    const subjJS = JSON.stringify(subjTemplate); // keep as string; replaced at runtime with NAME/EXAM/CODE

    // Student exam HTML
    return `<!DOCTYPE html>
<html lang="en" translate="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="google" content="notranslate">
  <meta http-equiv="Content-Language" content="en">
  <meta name="robots" content="no-translate">
  <title>${htmlEscape(cfg.title)}</title>

  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">

  <style>
    html, body { translate: none !important; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
    * { translate: none !important; }
    body { font-family: Arial, Helvetica, sans-serif; background: #f8f9fb; margin: 0; color: #222; font-size: 16px; line-height: 1.6; }
    header { background: linear-gradient(135deg, #004080, #0066cc); color: #ffffff; padding: 25px 20px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    header h1 { margin: 0; font-size: 1.9em; letter-spacing: 0.5px; }
    #timer { text-align: right; font-weight: bold; margin-top: 10px; }

    main { max-width: 900px; margin: 40px auto; background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 0 12px rgba(0,0,0,0.1); }

    .card { background: #ffffff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); padding: 40px; max-width: 520px; margin: 80px auto; text-align: left; }
    .card h2 { color: #004080; margin-top: 0; text-align: center; }

    label { display:block; margin: 12px 0 8px; font-weight: bold; }
    input[type="text"], input[type="email"], select { width: 100%; padding: 10px; border:1px solid #ccc; border-radius:6px; }
    textarea { width: 100%; padding: 10px; border:1px solid #ccc; border-radius:6px; }
    select { white-space: normal; word-wrap: break-word; padding: 8px; }

    button { background:#004080; color:#fff; border:none; padding:12px 28px; border-radius:6px; cursor:pointer; font-size:16px; }
    button:hover { background:#003666; }
    .btn-row { display:flex; gap:12px; flex-wrap: wrap; margin-top: 16px; }
    .btn-row.center { justify-content: center; }
    .btn-row.right { justify-content: flex-end; }
    .btn-light { background:#e9eef7; color:#004080; }
    .btn-light:hover { background:#dbe6f7; }

    ol { padding-left: 20px; }
    ol li { margin-bottom: 14px; }

    #exam, #confirm, #partA, #partB { display: none; }
    #partA.active, #partB.active { display: block; }

    .editor-card { border:1px solid #e3e6ee; border-radius:12px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
    .ql-toolbar.ql-snow { border:none; border-bottom:1px solid #e3e6ee; background:#f9fbff; }
    .ql-container.ql-snow { border:none; min-height: 260px; }
    .ql-editor { min-height: 240px; }

    .muted { color:#666; font-size: 14px; }
  </style>
</head>

<body>
  <header>
    <h1>${htmlEscape(cfg.title)} (${htmlEscape(cfg.classCode)})</h1>
    <div id="timer"></div>
  </header>

  <main>
    <!-- LOGIN -->
    <section id="login" class="card">
      <h2>Start Exam</h2>
      <p>Enter your details to begin. Once started, you will have <b>${timeLimit}</b> minutes.</p>
      <label>Name:</label><input type="text" id="studentName" required>
      <label>Email:</label><input type="email" id="studentEmail" required>
      <label>Class Code:</label><input type="text" id="classCode" required>
      <div class="btn-row center">
        <button id="startBtn" type="button">Start</button>
      </div>
    </section>

    <!-- CONFIRM -->
    <section id="confirm" class="card">
      <h2>Confirm Your Details</h2>
      <p><b>Name:</b> <span id="confirmName"></span></p>
      <p><b>Email:</b> <span id="confirmEmail"></span></p>
      <p class="muted">Please confirm your details. If anything is wrong, go back and correct it.</p>
      <div class="btn-row">
        <button type="button" class="btn-light" id="confirmBackBtn">← Back</button>
        <button type="button" id="confirmBeginBtn">Begin Exam →</button>
      </div>
    </section>

    <!-- EXAM -->
    <section id="exam">
      <form id="examForm">
        <input type="hidden" name="studentName" id="studentNameField">
        <input type="hidden" name="studentEmail" id="studentEmailField">
        <input type="hidden" name="classCode" id="classCodeField">

        <!-- PART A -->
        <div id="partA" class="active">
          <h2>Part A – Vocabulary Matching</h2>
          <ol>
            ${partAItemsHTML}
          </ol>

          <div class="btn-row right">
            <button type="button" id="toPartB">Next → Part B</button>
          </div>
        </div>

        <!-- PART B -->
        <div id="partB">
          <h2>Part B – Writing Task</h2>
          <p class="muted">${htmlEscape(cfg.prompt)}</p>

          <div class="editor-card">
            <div id="editor"></div>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-light" id="toPartA">← Back to Part A</button>
            <button type="submit">Submit Exam</button>
          </div>
        </div>
      </form>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>

  <script>
  document.addEventListener("DOMContentLoaded", function() {
    // EmailJS init (if key provided)
    ${cfg.emailjsKey ? `if (window.emailjs) { emailjs.init(${JSON.stringify(cfg.emailjsKey)}); }` : `// No EmailJS key provided; init skipped`}

    // Elements
    const login  = document.getElementById("login");
    const confirmSec = document.getElementById("confirm");
    const exam   = document.getElementById("exam");

    const startBtn = document.getElementById("startBtn");
    const confirmBackBtn  = document.getElementById("confirmBackBtn");
    const confirmBeginBtn = document.getElementById("confirmBeginBtn");

    const confirmName  = document.getElementById("confirmName");
    const confirmEmail = document.getElementById("confirmEmail");

    const partA = document.getElementById("partA");
    const partB = document.getElementById("partB");
    const toPartA = document.getElementById("toPartA");
    const toPartB = document.getElementById("toPartB");

    const timerDisplay = document.getElementById("timer");
    const form = document.getElementById("examForm");

    // Timer
    let timeLeft = ${timeLimit} * 60;
    let timer;

    // Correct answers and word list (from builder)
    const correctAnswers = ${correctAnswersJS};
    const wordNames = ${wordNamesJS};
    const totalQs = wordNames.length;

    // Lazy Quill
    let quill = null;
    function ensureQuill() {
      if (!quill) {
        quill = new Quill('#editor', {
          theme: 'snow',
          modules: {
            toolbar: [
              ['bold','italic','underline'],
              [{ list: 'ordered' }, { list: 'bullet' }],
              ['clean']
            ]
          }
        });
      }
    }

    function startTimer() {
      timer = setInterval(() => {
        timeLeft--;
        const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
        timerDisplay.textContent = \`Time Remaining: \${m}:\${s.toString().padStart(2,"0")}\`;
        if (timeLeft <= 0) { clearInterval(timer); submitExam(); }
      }, 1000);
    }

    function enableFullScreen() {
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(()=>{});
        document.addEventListener("fullscreenchange", () => {
          if (!document.fullscreenElement) {
            alert("Exam terminated. Fullscreen required.");
            location.reload();
          }
        });
      }
    }

    function randomizeSelectsKeepFirst() {
      document.querySelectorAll("#partA select").forEach(sel => {
        const opts = Array.from(sel.options);
        const first = opts.shift(); // "-- Choose --"
        for (let i = opts.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [opts[i].text, opts[j].text] = [opts[j].text, opts[i].text];
        }
        sel.innerHTML = "";
        sel.appendChild(first);
        opts.forEach(o => sel.appendChild(o));
        sel.selectedIndex = 0;
      });
    }

    // ----- Start → Confirm -----
    startBtn.addEventListener("click", () => {
      const name  = (document.getElementById("studentName").value || "").trim();
      const email = (document.getElementById("studentEmail").value || "").trim();
      const code  = (document.getElementById("classCode").value || "").trim();

      if (!name || !email) { alert("Please fill in your details."); return; }
      if (code !== ${JSON.stringify(cfg.classCode)}) { alert("Invalid class code."); return; }

      confirmName.textContent  = name;
      confirmEmail.textContent = email;

      login.style.display = "none";
      confirmSec.style.display = "block";
    });

    // ----- Confirm page buttons -----
    function beginExam() {
      const name  = (document.getElementById("studentName").value || "").trim();
      const email = (document.getElementById("studentEmail").value || "").trim();
      const code  = (document.getElementById("classCode").value || "").trim();

      document.getElementById("studentNameField").value  = name;
      document.getElementById("studentEmailField").value = email;
      document.getElementById("classCodeField").value    = code;

      confirmSec.style.display = "none";
      exam.style.display  = "block";
      partA.classList.add("active");
      partB.classList.remove("active");

      enableFullScreen();
      startTimer();
      randomizeSelectsKeepFirst();
    }

    confirmBackBtn.addEventListener("click", () => {
      confirmSec.style.display = "none";
      login.style.display = "block";
    });

    confirmBeginBtn.addEventListener("click", () => {
      beginExam();
    });

    // ----- Navigation Part A <-> Part B -----
    toPartB.addEventListener("click", () => {
      partA.classList.remove("active");
      partB.classList.add("active");
      ensureQuill();
    });
    toPartA.addEventListener("click", () => {
      partB.classList.remove("active");
      partA.classList.add("active");
    });

    // ----- Submit -----
    form.addEventListener("submit", e => {
      e.preventDefault();
      submitExam();
    });

    function submitExam() {
      clearInterval(timer);

      const fd = new FormData(form);
      const name  = fd.get("studentName")  || document.getElementById("studentNameField").value;
      const email = fd.get("studentEmail") || document.getElementById("studentEmailField").value;
      const minutesUsed = ${timeLimit} - Math.floor(timeLeft / 60);

      const emailHtml = quill ? quill.root.innerHTML.trim() : "<em>(No response)</em>";

      let scoreA = 0;
      let partARowsHTML = "";
      for (let i = 1; i <= totalQs; i++) {
        const sel  = fd.get("q" + i) || "No answer";
        const corr = correctAnswers["q" + i] || "";
        const ok   = sel === corr;
        if (ok) scoreA++;
        const mark = ok ? "✅ Correct" : \`❌ Incorrect → Correct answer: \${corr}\`;
        partARowsHTML += \`
          <tr>
            <td style="padding:8px;border:1px solid #ccc;">\${wordNames[i-1] || ("Q"+i)}</td>
            <td style="padding:8px;border:1px solid #ccc;">\${sel}</td>
            <td style="padding:8px;border:1px solid #ccc;color:\${ok ? 'green' : '#b00'};">\${mark}</td>
          </tr>\`;
      }

      const partBScore = "___ / 10";
      const finalNote  = "___ / 20";

      const htmlReport = \`
        <h2 style="color:#004080;margin:0 0 8px 0;">Results – ${htmlEscape(cfg.title)} – \${name} (${htmlEscape(cfg.classCode)})</h2>
        <table style="border-collapse:collapse;width:100%;max-width:640px;font-size:14px;margin:0 0 12px 0;">
          <tr><td style="padding:4px 0;"><b>Student Name:</b> \${name}</td></tr>
          <tr><td style="padding:4px 0;"><b>Student Email:</b> \${email}</td></tr>
          <tr><td style="padding:4px 0;"><b>Class Code:</b> ${htmlEscape(cfg.classCode)}</td></tr>
          <tr><td style="padding:4px 0;"><b>Time Taken:</b> \${minutesUsed} min</td></tr>
        </table>
        <hr style="border:none;border-top:1px solid #ddd;margin:14px 0;">

        <h3 style="color:#004080;margin:10px 0 8px 0;">Part A – Vocabulary Matching</h3>
        <table style="border-collapse:collapse;width:100%;font-size:15px;margin-top:8px;">
          <thead>
            <tr style="background:#004080;color:#fff;text-align:left;">
              <th style="padding:8px;border:1px solid #ccc;">Word</th>
              <th style="padding:8px;border:1px solid #ccc;">Student Answer</th>
              <th style="padding:8px;border:1px solid #ccc;">Result</th>
            </tr>
          </thead>
          <tbody>\${partARowsHTML}</tbody>
        </table>
        <p style="margin:10px 0 0 0;"><b>Part A Score:</b> \${scoreA} / \${totalQs}</p>

        <hr style="border:none;border-top:1px solid #ddd;margin:16px 0;">

        <h3 style="color:#004080;margin:10px 0 8px 0;">Part B – Written Exercise</h3>
        <div style="border:1px solid #ccc;border-radius:6px;padding:10px;background:#f9f9f9;">\${emailHtml}</div>

        <table style="border-collapse:collapse;width:100%;font-size:15px;margin-top:6px;">
          <thead>
            <tr style="background:#004080;color:#fff;text-align:left;">
              <th style="padding:8px;border:1px solid #ccc;">Criterion</th>
              <th style="padding:8px;border:1px solid #ccc;">Maximum</th>
              <th style="padding:8px;border:1px solid #ccc;">Awarded</th>
            </tr>
          </thead>
          <tbody>
            <tr><td style="padding:8px;border:1px solid #ccc;">Vocabulary Use</td><td style="padding:8px;border:1px solid #ccc;">/3</td><td style="padding:8px;border:1px solid #ccc;">___ / 3</td></tr>
            <tr><td style="padding:8px;border:1px solid #ccc;">Structure & Clarity</td><td style="padding:8px;border:1px solid #ccc;">/3</td><td style="padding:8px;border:1px solid #ccc;">___ / 3</td></tr>
            <tr><td style="padding:8px;border:1px solid #ccc;">Language Accuracy & Tone</td><td style="padding:8px;border:1px solid #ccc;">/2</td><td style="padding:8px;border:1px solid #ccc;">___ / 2</td></tr>
            <tr><td style="padding:8px;border:1px solid #ccc;">Professional Style</td><td style="padding:8px;border:1px solid #ccc;">/2</td><td style="padding:8px;border:1px solid #ccc;">___ / 2</td></tr>
          </tbody>
        </table>
        <p style="margin:10px 0 0 0;"><b>Part B Score:</b> \${partBScore}</p>

        <hr style="border:none;border-top:1px solid #ddd;margin:16px 0;">

        <h3 style="color:#004080;margin:10px 0 8px 0;">Part 3 – Final Score</h3>
        <table style="border-collapse:collapse;width:100%;max-width:460px;font-size:15px;">
          <tr><td style="padding:8px;border:1px solid #ccc;">Part A Score</td><td style="padding:8px;border:1px solid #ccc;">\${scoreA} / \${totalQs}</td></tr>
          <tr><td style="padding:8px;border:1px solid #ccc;">Part B Score</td><td style="padding:8px;border:1px solid #ccc;">\${partBScore}</td></tr>
          <tr><td style="padding:8px;border:1px solid #ccc;"><b>Final Note</b></td><td style="padding:8px;border:1px solid #ccc;"><b>\${finalNote}</b></td></tr>
        </table>

        <div style="border-top:1px solid #ccc;margin-top:16px;padding-top:8px;font-size:12px;color:#555;">
          <em>This report was generated automatically for ${htmlEscape(cfg.title)}.</em>
        </div>
      \`;

      // Subject with placeholders
      const subjectTemplate = ${subjJS};
      const subject = subjectTemplate
        .replace("(NAME)", name)
        .replace("(EXAM)", ${JSON.stringify(cfg.title)})
        .replace("(CODE)", ${JSON.stringify(cfg.classCode)});

      if (window.emailjs) {
        emailjs.send(${JSON.stringify(cfg.emailjsService)}, ${JSON.stringify(cfg.emailjsTemplate)}, {
          from_name: name,
          from_email: email,
          subject,
          message_html: htmlReport
        })
        .then(() => {
          alert("✅ Exam submitted successfully.");
          exam.style.display = "none";
        })
        .catch(err => {
          alert("❌ Error sending exam: " + (err && err.text ? err.text : err));
          console.error("EmailJS Error:", err);
        });
      } else {
        alert("EmailJS not loaded; submission simulated.");
      }
    }
  });
  </script>
</body>
</html>`;
  }

  /* ========== Generate & Auto-Download ========== */
  document.getElementById("generateBtn").addEventListener("click", () => {
    const title = (document.getElementById("examTitle").value || "English Exam").trim();
    const classCode = (document.getElementById("classCode").value || "CLASS").trim();
    const timeLimit = Math.max(5, +document.getElementById("timeLimit").value || 40);
    const emailSub = (document.getElementById("emailSubject").value || "Results – (NAME) – (EXAM) ((CODE))").trim();
    const emailjsKey = document.getElementById("emailjsKey").value.trim();
    const emailjsService = document.getElementById("emailjsService").value.trim();
    const emailjsTemplate = document.getElementById("emailjsTemplate").value.trim();

    // Collect only filled vocab rows
    const vocab = [];
    for (let i = 0; i < 10; i++) {
      const w = (document.getElementById("w" + i).value || "").trim();
      const d = (document.getElementById("d" + i).value || "").trim();
      if (w && d) vocab.push({ word: w, definition: d });
    }
    if (vocab.length === 0) {
      alert("Please add at least one Word + Definition row in Vocabulary.");
      return;
    }

    const prompt = (document.getElementById("promptText").value || "").trim();
    if (!prompt) {
      alert("Please enter a Part B prompt.");
      return;
    }

    const html = buildExamHTML({
      title,
      classCode,
      timeLimit,
      subject: emailSub,
      emailjsKey,
      emailjsService,
      emailjsTemplate,
      vocab,
      prompt,
    });
    if (!html) return;

    const blob = new Blob([html], { type: "text/html;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "English_Exam_" + classCode + ".html";
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  });

});
</script>
</body>
</html>
